// Prisma Schema para Domus AI - Sistema de Gestão de Reservas
// Database: MariaDB

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTENTICAÇÃO E USUÁRIOS
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  full_name    String
  role         Role     @default(USER)
  avatar_url   String?
  created_date DateTime @default(now())
  updated_date DateTime @updatedAt

  // Relacionamentos
  restaurants   Restaurant[]
  subscriptions Subscription[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

// ============================================
// ASSINATURAS
// ============================================

model Subscription {
  id                     String            @id @default(uuid())
  user_email             String
  plan_type              PlanType
  status                 SubscriptionStatus
  stripe_customer_id     String?
  stripe_subscription_id String?
  current_period_start   DateTime
  current_period_end     DateTime
  cancelled_at           DateTime?
  created_date           DateTime          @default(now())
  updated_date           DateTime          @updatedAt

  // Relacionamentos
  user User @relation(fields: [user_email], references: [email], onDelete: Cascade)

  @@index([user_email])
  @@index([status])
  @@map("subscriptions")
}

enum PlanType {
  DOMUS_FREE
  DOMUS_PAID
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  CANCELLED
  PAST_DUE
}

// ============================================
// RESTAURANTES
// ============================================

model Restaurant {
  id              String   @id @default(uuid())
  owner_email     String
  name            String
  slug            String   @unique
  phone           String
  address         String
  total_capacity  Int
  timezone        String   @default("America/Sao_Paulo")
  public          Boolean  @default(true)
  operating_hours Json?
  created_date    DateTime @default(now())
  updated_date    DateTime @updatedAt

  // Relacionamentos
  owner        User          @relation(fields: [owner_email], references: [email], onDelete: Cascade)
  customers    Customer[]
  tables       Table[]
  environments Environment[]
  shifts       Shift[]
  reservations Reservation[]

  @@index([owner_email])
  @@index([slug])
  @@map("restaurants")
}

// ============================================
// CLIENTES
// ============================================

model Customer {
  id                 String   @id @default(uuid())
  restaurant_id      String
  owner_email        String
  full_name          String
  phone_whatsapp     String
  email              String?
  birth_date         DateTime?
  total_reservations Int      @default(0)
  total_spent        Decimal  @default(0) @db.Decimal(10, 2)
  created_date       DateTime @default(now())
  updated_date       DateTime @updatedAt

  // Relacionamentos
  restaurant   Restaurant    @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  reservations Reservation[]

  @@index([restaurant_id])
  @@index([phone_whatsapp])
  @@index([email])
  @@map("customers")
}

// ============================================
// AMBIENTES
// ============================================

model Environment {
  id            String   @id @default(uuid())
  restaurant_id String
  owner_email   String
  name          String
  capacity      Int?
  created_date  DateTime @default(now())
  updated_date  DateTime @updatedAt

  // Relacionamentos
  restaurant   Restaurant    @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  tables       Table[]
  reservations Reservation[]

  @@index([restaurant_id])
  @@map("environments")
}

// ============================================
// MESAS
// ============================================

model Table {
  id             String      @id @default(uuid())
  restaurant_id  String
  owner_email    String
  name           String
  seats          Int
  environment_id String?
  is_active      Boolean     @default(true)
  status         TableStatus @default(AVAILABLE)
  position_x     Int?
  position_y     Int?
  created_date   DateTime    @default(now())
  updated_date   DateTime    @updatedAt

  // Relacionamentos
  restaurant   Restaurant    @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  environment  Environment?  @relation(fields: [environment_id], references: [id], onDelete: SetNull)
  reservations Reservation[]

  @@index([restaurant_id])
  @@index([environment_id])
  @@index([status])
  @@map("tables")
}

enum TableStatus {
  AVAILABLE
  UNAVAILABLE
  BLOCKED
}

// ============================================
// TURNOS
// ============================================

model Shift {
  id                      String   @id @default(uuid())
  restaurant_id           String
  owner_email             String
  name                    String
  start_time              String // HH:mm format
  end_time                String // HH:mm format
  slot_interval_minutes   Int      @default(15)
  default_dwell_minutes   Int      @default(90)
  default_buffer_minutes  Int      @default(10)
  max_capacity            Int?
  days_of_week            Json // Array de números [0-6]
  active                  Boolean  @default(true)
  created_date            DateTime @default(now())
  updated_date            DateTime @updatedAt

  // Relacionamentos
  restaurant   Restaurant    @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  reservations Reservation[]

  @@index([restaurant_id])
  @@index([active])
  @@map("shifts")
}

// ============================================
// RESERVAS
// ============================================

model Reservation {
  id               String            @id @default(uuid())
  restaurant_id    String
  owner_email      String
  customer_id      String
  reservation_code String            @unique
  date             DateTime          @db.Date
  shift_id         String
  slot_time        String // HH:mm format
  party_size       Int
  table_id         String
  linked_tables    Json // Array de IDs de mesas
  environment_id   String?
  status           ReservationStatus @default(PENDING)
  source           ReservationSource
  notes            String?           @db.Text
  created_date     DateTime          @default(now())
  updated_date     DateTime          @updatedAt

  // Relacionamentos
  restaurant  Restaurant   @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  customer    Customer     @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  table       Table        @relation(fields: [table_id], references: [id], onDelete: Cascade)
  shift       Shift        @relation(fields: [shift_id], references: [id], onDelete: Cascade)
  environment Environment? @relation(fields: [environment_id], references: [id], onDelete: SetNull)

  @@index([restaurant_id])
  @@index([customer_id])
  @@index([date])
  @@index([status])
  @@index([shift_id])
  @@index([table_id])
  @@index([reservation_code])
  @@map("reservations")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum ReservationSource {
  PHONE
  ONLINE
}

